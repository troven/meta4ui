<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-menu/paper-menu.html">
<link rel="import" href="/bower_components/paper-menu-button/paper-menu-button.html">
<script src="/bower_components/zepto/zepto.min.js"></script>
<script src="/bower_components/lodash/lodash.min.js"></script>

<dom-module id="meta4-crud-api">
    <style>
        :host {
            display: block;
            padding: 0px;
        }
    </style>

    <script>


        (function() {
            var _isEmpty = function(obj) {
                return !obj || ( Object.keys(obj).length === 0 && obj.constructor === Object );
            }

            Polymer({
                is: 'meta4-crud-api',
                properties: {
                    debug: {
                        type: Boolean,
                        value: false
                    },
                    auto: {
                        type: Boolean,
                        value: false
                    },
                    url: {
                        type: String
                    },
                    idProperty: {
                        type: String
                    },
                    token: {
                        notify: true,
                        type: Object,
                        readonly: true
                    },
                    local: {
                        notify: true,
                        type: Object
                    },
                    dataSource: {
                        notify: true,
                        type: Object
                    },
                    xhr: {
                        type: Object,
                        notify: true,
                        readOnly: true
                    }
                },
                observers: [
                    "tokenChanged(token)",
                    "urlChanged(url)",
                    "localDataChanged(local)"
                ],
                _sanitizeHeaders: function(headers) {
                    var headers = headers || this.headers;
                    for (header in headers) {
                        headers[header] = this.headers[header].toString();
                    }
                },
                ready: function() {
                    this.set("local", this.local || [] );
                    this.idProperty = this.idProperty?this.idProperty:"_id";

                    this.dataSource = new DataSource({ id: this.url, idProperty: this.idProperty, debug: this.debug });

                    this.set("dataSource", this.dataSource);

                    console.log("API ready: %o -> %s [%s] -> %o", this.url, this.idProperty?this.idProperty:false, this.auto?"auto":"manual", this.dataSource);
                    if (this.dataSource && !this.dataSource.refresh) {
                        throw "DataSource Error";
                    }

                    this.listenForCrudEvents();
                    this.addEventListener("onfocus", function(event) {
                        console.log("on-focus");
                    });
                    this.addEventListener("focus", function(event) {
                        console.log("got-focus");
                    });

//                    this.auto && this.read();
                },

                listenForCrudEvents: function(that) {
                    var self = this;
                    that = that || this;

                    that.addEventListener("create", function(event) { event.stopPropagation(); self.create(event.detail) });
                    that.addEventListener("read", function(event) { event.stopPropagation(); self.read(event.detail) });
                    that.addEventListener("update", function(event) { event.stopPropagation(); self.update(event.detail) });
                    that.addEventListener("save", function(event) { event.stopPropagation(); self.save(event.detail) });
                    that.addEventListener("delete", function(event) { event.stopPropagation(); self.delete(event.detail) });
                },

                notify: function() {
                    var self = this;
                    var args = arguments;
                    var children = self.childNodes;
                    // console.log("notify: %o -> %o", arguments, children);
                    children.forEach(function(child) {
                        child.fire && child.fire.apply(self, args);
                    })
                },

                localDataChanged: function(items) {
                    if (this.dataSource && this.dataSource.refresh) {
                        this.dataSource.refresh(items);
                        console.warn("[r]localDataChanged: %s -> %o -> %o", this.url, items, this.dataSource);
                    } else {
                        this.set("local", items);
                        // console.log("[-]localDataChanged: %s -> %o -> %o", this.url, items, this.dataSource);
                    }
                },

                tokenChanged: function(token) {
                    // console.log("Token Changed: %o", token);
                    token && this.auto && this.read();
                },

                urlChanged: function(url) {
                    this.debug && console.log("URL changed: %o", this.url, url);
                    url && this.auto && this.read();
                },

                // CRUD

                create: function(model) {
                    if (!model) throw new Error("empty create");
                    var self = this;
                    this.debug && console.warn("api create: %o", model);
                    var requested = this.doPost(model);

                    requested.then(function(r) {
                        console.log("created: %o -> %o", model, r);
                        self.notify("saved", r);
                        self.notify("created", r);
                    });

                    return requested;
                },

                read: function() {
                    var self = this;
                    var requested = this.doGet.apply(this, arguments);
                    requested.then(function(r) { self.set("local",r) });
                    return requested;

                },

                update: function(model) {
                    if (!model) throw new Error("empty update");
                    var self = this;
                    this.debug && console.warn("api update: %o", model);
                    var requested = this.doPut(model);

                    requested.then(function(r) {
                        console.log("updated: %o -> %o", model, r);
                        self.notify("saved", r);
                        self.notify("updated", r);
                    });

                    return requested;
                },

                delete: function(model) {
                    if (!model) throw new Error("empty delete");
                    var self = this;
                    this.debug && console.warn("api delete: %o", model);
                    var requested = this.doDelete(model);

                    requested.then(function(r) {
                        console.log("deleted: %o -> %o", model, r);
                        self.notify("deleted", r);
                    });

                    return requested;
                },

                save: function(model) {
                    if (!model) throw new Error("empty save");
                    var self = this;
                    this.debug && console.warn("api save: %o", model);
                    var requested = false;
                    if (model._key) {
                        requested = this.update(model);
                    } else {
                        requested = this.create(model);
                    }

                    requested.then(function(r) {
                        console.log("saved: %o -> %o", model, r);
                        self.notify("saved", r);
                    });

                    return requested;
                },

                ajaxRequest: function(cmd) {
                    var self = this;
                    var promise = new Promise(function(resolve, reject) {
                        var ajax = { type: cmd.type, url: cmd.url, headers: {} };

                        if (cmd.data) {
                            ajax.data = cmd.data
                        }
                        var token = this.token || cmd.access_token;
                        if (token) {
                            ajax.headers.Authorization = "BEARER " + cmd.token;
                        }
                        ajax.success = resolve;
                        ajax.error = function(xhr, err, msg) {
                            reject.apply(self, arguments);

                            if (xhr.responseJSON) {
                                var error = xhr.responseJSON;
                                self.debug && console.error("CRUD error: %o", error);
                                var message = error.errorMessage;
                                alert(message);
                            } else {
                                self.debug && console.error("ERROR GetMany: %o", arguments);
                                alert("ERROR: "+msg +" @ "+cmd.url);
                            }
                        }

                        self.debug && console.log("ajax request[%s]: %o -> %o", cmd.type, cmd.url, ajax);
                        $.ajax(ajax);
                    });

                    return promise;
                },

                // HTTP METHODS

                doGet: function(id) {
                    if (!this.url) {
                        console.log("get: %o -> %o", this.url?this.url:"no url", this.token?this.token:"no token");
                        return;
                    }
                    if (!id || _.isObject(id)) {
                        return this.doGetMany(id);
                    }
                    if (_.isString(id)) {
                        return this.doGetOne(id);
                    }
                },

                doGetOne: function(id) {
                    var self = this;
                    this.debug && console.log("get-one: %o -> %o", this.url?this.url:"no url", this.token?this.token:"no token");

                    var request = this.ajaxRequest({ type: "GET", url: this.url+id, token: this.token });
                    return request;
                },

                doGetMany: function(queryParams) {
                    var self = this;
                    this.started = new Date().getTime();

                    this.debug && console.log("get-many: %o -> %o -> %o -> %o", this.url, this.token, this.started, queryParams);
                    var request = this.ajaxRequest({ type: "GET", url: this.url, token: this.token, data: queryParams });
                    return request;
                },

                doPost: function(item) {
                    this.debug && console.log("doPost: %o -> %o -> %o", this.url, this.token, item);
                    item = JSON.stringify(item);
                    return this.ajaxRequest({ type: "POST", url: this.url, token: this.token, data: item });
                },

                doPut: function(item) {
                    this.debug && console.log("doPut: %o -> %o -> %o", this.url, this.token, item);
                    item = JSON.stringify(item);
                    var requested = this.ajaxRequest({ type: "PUT", url: this.url, token: this.token, dataType: "json", data: item });
                    return requested;
                },

                doDelete: function(item) {
                    this.debug && console.log("doDelete: %o -> %o -> %o", this.url, this.token, item);
                    item = JSON.stringify(item);
                    var requested = this.ajaxRequest({ type: "DELETE", url: this.url, token: this.token, data: item });
                    return requested;
                }
            });
        }());
    </script>
</dom-module>
